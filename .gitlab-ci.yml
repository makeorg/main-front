image: makeorg/docker-sbt-coursier-nvm

variables:
  CI_BUILD: "true"
  SBT_OPTS: "-Xms2G -Xmx2G"

stages:
  - build
  - deploy

build:
  stage: build
  tags:
    - docker
  before_script:
    - if [ ! -e /var/run/docker.sock ]; then DOCKER_DRIVER=vfs dockerd & fi
    - until docker ps; do echo "waiting for docker to be up..."; sleep 0.5; done
    - docker login "https://$NEXUS_URL" --username "$NEXUS_USER" --password "$NEXUS_PASSWORD"
    - . /root/.profile
  script:
    - sbt clean publish
    - docker tag $NEXUS_URL/repository/docker-dev/make-front:$CI_COMMIT_REF_NAME-`date +"%Y-%m-%d"`-`git rev-parse --short HEAD` $NEXUS_URL/repository/docker-dev/make-front:$CI_COMMIT_REF_NAME-latest
    - docker push $NEXUS_URL/repository/docker-dev/make-front:$CI_COMMIT_REF_NAME-latest


deploy:
  stage: deploy
  only:
    - preproduction
  script:
    - >
      curl -D - -X "POST"
      -H "Accept: application/json"
      -H "Content-Type: application/x-www-form-urlencoded"
      -H "X-Rundeck-Auth-Token: $RUNDECK_TOKEN"
      --data-urlencode "argString=-version $CI_COMMIT_REF_NAME-latest"
      https://rundeck.preprod.makeorg.tech/api/16/job/465ecd16-8da9-4f57-aac6-a3d1ce92a3fa/run
